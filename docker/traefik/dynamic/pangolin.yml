http:
  middlewares:
    cloudflarewarp:
      plugin:
        cloudflarewarp:
          disableDefault: false

    redirect-to-https:
      redirectScheme:
        scheme: https

  routers:
    # HTTP to HTTPS redirect router
    main-app-router-redirect:
      rule: 'Host(`pangolin.{{ env "DOMAIN" }}`)'
      service: next-service
      entryPoints:
        - web
      middlewares:
        - redirect-to-https

    # Next.js router (handles everything except API and WebSocket paths)
    next-router:
      rule: 'Host(`pangolin.{{ env "DOMAIN" }}`) && !PathPrefix(`/api/v1`)'
      service: next-service
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
        domains:
          - main: '{{ env "DOMAIN" }}'
            sans:
              - '*.{{ env "DOMAIN" }}'

    # API router (handles /api/v1 paths)
    api-router:
      rule: 'Host(`pangolin.{{ env "DOMAIN" }}`) && PathPrefix(`/api/v1`)'
      service: api-service
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # WebSocket router
    ws-router:
      rule: 'Host(`pangolin.{{ env "DOMAIN" }}`)'
      service: api-service
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # =========================================================================
    # Internal (Tailnet-only) Pangolin Access
    # =========================================================================
    # These routers expose Pangolin at pangolin.mothership.${DOMAIN}
    # Only accessible from Tailscale/private networks via internal middleware
    # =========================================================================

    # HTTP to HTTPS redirect for internal access
    pangolin-internal-redirect:
      rule: 'Host(`pangolin.mothership.{{ env "DOMAIN" }}`)'
      service: next-service
      entryPoints:
        - web
      middlewares:
        - redirect-to-https

    # Next.js router (internal)
    pangolin-internal-next:
      rule: 'Host(`pangolin.mothership.{{ env "DOMAIN" }}`) && !PathPrefix(`/api/v1`)'
      service: next-service
      entryPoints:
        - websecure
      middlewares:
        - internal@file
      tls:
        certResolver: letsencrypt

    # API router (internal)
    pangolin-internal-api:
      rule: 'Host(`pangolin.mothership.{{ env "DOMAIN" }}`) && PathPrefix(`/api/v1`)'
      service: api-service
      entryPoints:
        - websecure
      middlewares:
        - internal@file
      tls:
        certResolver: letsencrypt

    # WebSocket router (internal)
    pangolin-internal-ws:
      rule: 'Host(`pangolin.mothership.{{ env "DOMAIN" }}`)'
      service: api-service
      entryPoints:
        - websecure
      middlewares:
        - internal@file
      tls:
        certResolver: letsencrypt

  services:
    next-service:
      loadBalancer:
        servers:
          - url: "http://pangolin:3002"  # Next.js server

    api-service:
      loadBalancer:
        servers:
          - url: "http://pangolin:3000"  # API/WebSocket server

tcp:
  serversTransports:
    pp-transport-v1:
      proxyProtocol:
        version: 1
    pp-transport-v2:
      proxyProtocol:
        version: 2
