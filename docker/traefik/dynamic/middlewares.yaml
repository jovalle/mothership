# =============================================================================
# Traefik Dynamic Configuration - Security Middlewares
# =============================================================================
# Simplified middleware naming and structure for clarity
# =============================================================================

http:
  middlewares:

    # -------------------------------------------------------------------------
    # auth-oidc - OpenID Connect Authentication via Pocket ID
    # -------------------------------------------------------------------------
    # Requires users to authenticate via Pocket ID before accessing services.
    # Uses the OAuth 2.0 Authorization Code flow with PKCE.
    #
    # Flow:
    #   1. User visits protected service
    #   2. Redirected to Pocket ID login page
    #   3. User authenticates (password, passkey, etc.)
    #   4. Redirected back to service with auth token
    #   5. Token validated, access granted
    #
    # Session cookies maintain auth state across requests.
    #
    # Scopes requested:
    #   - openid: Required for OIDC
    #   - profile: User's name
    #   - email: User's email
    #   - groups: Group memberships (for authorization)
    #
    # SETUP REQUIRED:
    #   1. Create OIDC client in Pocket ID admin
    #   2. Set redirect URL: https://*.${DOMAIN}/oidc/callback
    #   3. Set logout URL: https://*.${DOMAIN}/oidc/logout
    #   4. Configure env vars: POCKET_ID_CLIENT_ID, POCKET_ID_CLIENT_SECRET,
    #      POCKET_ID_OIDC_SECRET
    # -------------------------------------------------------------------------
    auth-oidc:
      plugin:
        traefik-oidc-auth:
          LogoutUri: https://{host}/oidc/logout
          Provider:
            ClientId: '{{ env "POCKET_ID_CLIENT_ID" }}'
            ClientSecret: '{{ env "POCKET_ID_CLIENT_SECRET" }}'
            Url: https://pocket.{{ env "DOMAIN" }}
          RedirectUri: https://{host}/oidc/callback
          Scopes:
            - openid
            - profile
            - email
            - groups
          Secret: '{{ env "POCKET_ID_OIDC_SECRET" }}'

    # -------------------------------------------------------------------------
    # crowdsec - Intrusion Detection & Prevention (IDS/IPS)
    # -------------------------------------------------------------------------
    # Integrates with CrowdSec security engine to block malicious IPs.
    # CrowdSec analyzes logs and shares threat intelligence with a global
    # community to identify:
    #   - Brute force attacks
    #   - Vulnerability scanners
    #   - Known malicious IPs
    #   - Bot networks
    #
    # Mode: stream - Traefik streams decisions from CrowdSec LAPI
    # updateIntervalSeconds: How often to fetch new ban decisions
    #
    # forwardedHeadersTrustedIPs: Cloudflare IPs that are trusted to set
    # the CF-Connecting-IP header (must match external-ips allowlist)
    #
    # clientTrustedIPs: Internal IPs that bypass CrowdSec checks
    # -------------------------------------------------------------------------
    crowdsec:
      plugin:
        crowdsec:
          clientTrustedIPs:
            - 10.0.0.0/8
            - 100.64.0.0/10
            - 172.16.0.0/12
            - 192.168.0.0/16
          crowdsecAppsecEnabled: false
          crowdsecAppsecFailureBlock: true
          crowdsecAppsecHost: crowdsec:7422
          crowdsecAppsecUnreachableBlock: false
          crowdsecLapiHost: crowdsec:8080
          crowdsecLapiKey: '{{ env "CROWDSEC_BOUNCER_KEY" }}'
          crowdsecLapiScheme: http
          crowdsecMode: stream
          defaultDecisionSeconds: 60
          enabled: true
          forwardedHeadersCustomName: CF-Connecting-IP
          forwardedHeadersTrustedIPs:
            - 103.21.244.0/22
            - 103.22.200.0/22
            - 103.31.4.0/22
            - 104.16.0.0/13
            - 104.24.0.0/14
            - 108.162.192.0/18
            - 131.0.72.0/22
            - 141.101.64.0/18
            - 162.158.0.0/15
            - 172.64.0.0/13
            - 173.245.48.0/20
            - 188.114.96.0/20
            - 190.93.240.0/20
            - 197.234.240.0/22
            - 198.41.128.0/17
            - 2400:cb00::/32
            - 2405:8100::/32
            - 2405:b500::/32
            - 2606:4700::/32
            - 2803:f800::/32
            - 2a06:98c0::/29
            - 2c0f:f248::/32
          httpTimeoutSeconds: 10
          logLevel: INFO
          updateIntervalSeconds: 15

    # -------------------------------------------------------------------------
    # external - Public Internet Access via Cloudflare
    # -------------------------------------------------------------------------
    # Use for: Auth providers, public status pages, landing pages
    #
    # Security layers (in order):
    #   1. external-ips: Only Cloudflare proxy IPs + trusted servers allowed
    #   2. real-ip: Extract real client IP from CF headers
    #   3. crowdsec: Block known malicious IPs
    #   4. ratelimit: Prevent request flooding
    #   5. geoblock: Allow only configured countries
    #   6. headers: Security headers applied
    #
    # NO AUTHENTICATION - anyone can access after passing security checks.
    # Use only for services that handle their own auth (Authelia, Pocket ID)
    # or truly public services (status pages).
    #
    # Example services: Authelia, Pocket ID, Gatus status page
    #
    # Usage:
    #   traefik.http.routers.myapp.middlewares: external@file
    # -------------------------------------------------------------------------
    external:
      chain:
        middlewares:
          - external-ips
          - real-ip
          - crowdsec
          - ratelimit
          - geoblock
          - headers

    # -------------------------------------------------------------------------
    # external-ips - Cloudflare + Internal Networks Allowlist
    # -------------------------------------------------------------------------
    # Restricts access to requests originating from:
    #   - Cloudflare's proxy IPs (external internet traffic)
    #   - Docker bridge networks (health checks, inter-service calls)
    #   - Tailscale/Private networks (internal access)
    #
    # This ensures external traffic comes through Cloudflare while allowing:
    #   - Gatus health checks from within Docker
    #   - Pangolin/Gerbil newt connections
    #   - Internal service-to-service communication
    #
    # IP ranges are maintained by Cloudflare:
    #   https://www.cloudflare.com/ips/
    #
    # IMPORTANT: Keep Cloudflare ranges updated. Cloudflare adds new ranges
    # periodically. Outdated ranges will block legitimate traffic.
    # -------------------------------------------------------------------------
    external-ips:
      ipAllowList:
        ipStrategy:
          depth: 0
        sourceRange:
          # Docker bridge networks
          - 172.16.0.0/12
          - 192.168.0.0/16
          # Tailscale CGNAT
          - 100.64.0.0/10
          # Private networks
          - 10.0.0.0/8
          # Localhost
          - 127.0.0.1/32
          - "::1/128"
          # This server's public IP (for hairpin NAT / health checks)
          - '{{ env "EXTERNAL_IP" }}/32'
          # Cloudflare IPv4
          - 103.21.244.0/22
          - 103.22.200.0/22
          - 103.31.4.0/22
          - 104.16.0.0/13
          - 104.24.0.0/14
          - 108.162.192.0/18
          - 131.0.72.0/22
          - 141.101.64.0/18
          - 162.158.0.0/15
          - 172.64.0.0/13
          - 173.245.48.0/20
          - 188.114.96.0/20
          - 190.93.240.0/20
          - 197.234.240.0/22
          - 198.41.128.0/17
          # Cloudflare IPv6
          - 2400:cb00::/32
          - 2405:8100::/32
          - 2405:b500::/32
          - 2606:4700::/32
          - 2803:f800::/32
          - 2a06:98c0::/29
          - 2c0f:f248::/32

    # -------------------------------------------------------------------------
    # external-oidc - Public Access with OIDC Authentication
    # -------------------------------------------------------------------------
    # Use for: Services that need internet access but require login
    #
    # Security layers (in order):
    #   1. external-ips: Only Cloudflare proxy IPs allowed
    #   2. real-ip: Extract real client IP from CF headers
    #   3. crowdsec: Block known malicious IPs
    #   4. ratelimit: Prevent request flooding
    #   5. geoblock: Allow only configured countries
    #   6. auth-oidc: Require Pocket ID login
    #   7. headers: Security headers applied
    #
    # Users must authenticate via Pocket ID before accessing the service.
    #
    # Example services: Remote admin panels, private dashboards exposed
    # to the internet for remote access
    #
    # Usage:
    #   traefik.http.routers.myapp.middlewares: external-oidc@file
    # -------------------------------------------------------------------------
    external-oidc:
      chain:
        middlewares:
          - external-ips
          - real-ip
          - crowdsec
          - ratelimit
          - geoblock
          - auth-oidc
          - headers

    # -------------------------------------------------------------------------
    # geoblock - Country-Based Access Control
    # -------------------------------------------------------------------------
    # Restricts access based on the client's geographic location.
    # Uses Cloudflare's CF-IPCountry header for geo detection.
    #
    # Configuration:
    #   - blackListMode: false = allowlist mode (only listed countries allowed)
    #   - countries: List of allowed country codes (ISO 3166-1 alpha-2)
    #   - allowLocalRequests: Allows RFC1918 IPs regardless of geo
    #   - allowedIPAddresses: Explicit IP allowlist (bypasses geo check)
    #
    # Currently configured to allow only US traffic.
    # Modify the countries list based on your user base.
    #
    # Common country codes: US, CA, GB, DE, FR, AU, JP, etc.
    # -------------------------------------------------------------------------
    geoblock:
      plugin:
        geoblock:
          allowLocalRequests: true
          allowUnknownCountries: false
          allowedIPAddresses:
            # Private networks
            - 10.0.0.0/8
            - 100.64.0.0/10
            - 172.16.0.0/12
            - 192.168.0.0/16
            # Trusted public IPs (servers for health checks / hairpin NAT)
            - '{{ env "EXTERNAL_IP" }}/32'
            - '{{ env "STARGATE_IP" }}/32'
          api: https://get.geojs.io/v1/ip/country/{ip}
          apiTimeoutMs: 1000
          blackListMode: false
          cacheSize: 100
          countries:
            - US
          forceMonthlyUpdate: true
          ipGeolocationHttpHeaderField: CF-IPCountry
          logAllowedRequests: false
          logApiRequests: false
          logLocalRequests: false
          silentStartUp: false
          unknownCountryApiResponse: nil

    # -------------------------------------------------------------------------
    # headers - Security Response Headers
    # -------------------------------------------------------------------------
    # Adds security headers to all responses. These headers instruct browsers
    # to enable various security features.
    #
    # Headers applied:
    #   - X-XSS-Protection: Enables browser XSS filtering
    #   - X-Content-Type-Options: nosniff - Prevents MIME type sniffing
    #   - X-Frame-Options: SAMEORIGIN - Prevents clickjacking
    #   - Strict-Transport-Security: Forces HTTPS for 1 year
    #   - Referrer-Policy: Controls referrer information leakage
    #   - Permissions-Policy: Disables camera, microphone, geolocation, payment
    #   - X-Robots-Tag: Prevents search engine indexing
    #   - Server: Removed to hide server identity
    # -------------------------------------------------------------------------
    headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        customFrameOptionsValue: SAMEORIGIN
        customResponseHeaders:
          X-Download-Options: noopen
          X-Permitted-Cross-Domain-Policies: none
          X-Robots-Tag: noindex, nofollow
          server: ""
        frameDeny: true
        permissionsPolicy: camera=(), microphone=(), geolocation=(), payment=()
        referrerPolicy: strict-origin-when-cross-origin
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

    # -------------------------------------------------------------------------
    # internal - Tailscale VPN Access Only (DEFAULT)
    # -------------------------------------------------------------------------
    # Use for: Admin dashboards, internal tools, sensitive services
    #
    # Security layers:
    #   1. internal-ips: Only Tailscale/private IPs allowed
    #   2. headers: Security headers applied
    #
    # This is applied by default via the websecure entrypoint.
    # Services don't need to specify any middleware label.
    #
    # Example services: AdGuard, GoAccess, Traefik Dashboard, Whoami
    # -------------------------------------------------------------------------
    internal:
      chain:
        middlewares:
          - internal-ips
          - headers

    # -------------------------------------------------------------------------
    # internal-ips - Tailscale & Private Network Allowlist
    # -------------------------------------------------------------------------
    # Restricts access to requests originating from:
    #   - Tailscale CGNAT range (100.64.0.0/10)
    #   - Tailscale IPv6 (fd7a:115c:a1e0::/48)
    #   - RFC1918 private ranges (10.x, 172.16-31.x, 192.168.x)
    #   - Localhost
    #
    # All other IPs are rejected with 403 Forbidden.
    #
    # ipStrategy.depth: 0 means use the direct connecting IP (no proxy trust)
    # -------------------------------------------------------------------------
    internal-ips:
      ipAllowList:
        ipStrategy:
          depth: 0
        sourceRange:
          - 100.64.0.0/10
          - fd7a:115c:a1e0::/48
          - 10.0.0.0/8
          - 172.16.0.0/12
          - 192.168.0.0/16
          - 127.0.0.1/32
          - "::1/128"

    # -------------------------------------------------------------------------
    # ratelimit - Request Rate Limiting
    # -------------------------------------------------------------------------
    # Limits requests per client to prevent abuse and DoS attacks.
    #
    # Configuration:
    #   - average: 100 requests per minute sustained
    #   - burst: 200 requests allowed in a burst
    #   - period: 1 minute window
    #
    # sourceCriterion: Uses CF-Connecting-IP header to identify clients
    # (requires real-ip middleware to run first in the chain)
    #
    # When limit is exceeded, returns 429 Too Many Requests.
    # -------------------------------------------------------------------------
    ratelimit:
      rateLimit:
        average: 100
        burst: 200
        period: 1m
        sourceCriterion:
          requestHeaderName: CF-Connecting-IP

    # -------------------------------------------------------------------------
    # real-ip - Extract Real Client IP from Headers
    # -------------------------------------------------------------------------
    # When behind Cloudflare, the connecting IP is Cloudflare's proxy, not
    # the real client. This middleware extracts the real client IP from
    # the CF-Connecting-IP or X-Forwarded-For headers.
    #
    # This is critical for:
    #   - Rate limiting by real client IP
    #   - CrowdSec threat detection
    #   - Access logging
    #   - Geo-blocking
    #
    # excludednets: IPs that should never be treated as proxies
    # -------------------------------------------------------------------------
    real-ip:
      plugin:
        real-ip:
          excludednets:
            - 127.0.0.0/8
