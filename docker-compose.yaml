# =============================================================================
# Mothership - Hardened Traefik Stack with Full Security Suite
# =============================================================================
networks:
  external:
    driver: bridge
    enable_ipv6: true
    name: external
    ipam:
      config:
        - subnet: 172.18.0.0/16
  internal:
    driver: bridge

services:

  # ===========================================================================
  # AdGuard Home - DNS
  # ===========================================================================
  adguard:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - NET_BIND_SERVICE
      - SETGID
      - SETUID
    cap_drop:
      - ALL
    container_name: adguard
    depends_on:
      tailscale:
        condition: service_healthy
    dns:
      - 76.76.2.2
      - 76.76.10.2
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:80 || exit 1" ]
      timeout: 10s
    hostname: adguard
    image: adguard/adguardhome
    labels:
      traefik.enable: true
      traefik.http.routers.adguard.middlewares: internal@file
      traefik.http.routers.adguard.rule: Host(`adguard.mothership.${DOMAIN}`)
      traefik.http.routers.adguard.service: adguard
      traefik.http.services.adguard.loadbalancer.server.port: 80
    networks:
      - internal
    ports:
      - ${INTERNAL_IP:?internal IP not set}:53:53/tcp
      - ${INTERNAL_IP}:53:53/udp
      - ${INTERNAL_IP}:853:853/tcp
      - ${INTERNAL_IP}:853:853/udp
      - ${INTERNAL_IP}:3000:3000/tcp
      - ${INTERNAL_IP}:5443:5443/tcp
      - ${INTERNAL_IP}:5443:5443/udp
      - ${INTERNAL_IP}:6060:6060/tcp
      - ${INTERNAL_IP}:8843:443/tcp
      - ${INTERNAL_IP}:8880:80/tcp
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./docker/adguard/conf:/opt/adguardhome/conf
      - ./docker/adguard/work:/opt/adguardhome/work

  # ===========================================================================
  # Beszel Agent - System Monitoring Agent
  # ===========================================================================
  beszel-agent:
    cap_drop:
      - ALL
    container_name: beszel-agent
    environment:
      HUB_URL: https://beszel.${DOMAIN}
      KEY: ${BESZEL_AGENT_KEY:?Beszel agent key required}
      LISTEN: 45876
      TOKEN: ${BESZEL_AGENT_TOKEN:?Beszel agent token required}
    image: henrygd/beszel-agent
    network_mode: host
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./docker/beszel-agent:/var/lib/beszel-agent
      - /:/extra-filesystems/rootfs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ===========================================================================
  # Cloudflared - Cloudflare Tunnel Client
  # ===========================================================================
  cloudflared:
    cap_drop:
      - ALL
    command: tunnel --no-autoupdate run
    container_name: cloudflared
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARED_TOKEN:?no cloudflared token provided}
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 60s
      test: [ "CMD", "cloudflared", "version" ]
      timeout: 10s
    image: cloudflare/cloudflared
    networks:
      - internal
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: 65532:65532

  # ===========================================================================
  # CrowdSec - Security Engine (IDS/IPS + WAF)
  # ===========================================================================
  crowdsec:
    cap_add:
      - NET_BIND_SERVICE
    cap_drop:
      - ALL
    container_name: crowdsec
    environment:
      # Collections to install
      # Bouncer key for Traefik plugin (will be generated on first run)
      BOUNCER_KEY_TRAEFIK: ${CROWDSEC_BOUNCER_KEY:-}
      COLLECTIONS: >-
        crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/iptables crowdsecurity/linux
      # Disable online API enrollment on first run (configure manually)
      DISABLE_ONLINE_API: false
      # Timezone
      TZ: ${TZ:-UTC}
      # Enable AppSec (WAF)
      USE_APPSEC: true
    healthcheck:
      test:
        - CMD
        - cscli
        - lapi
        - status
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    hostname: crowdsec
    image: crowdsecurity/crowdsec
    networks:
      - internal
    ports:
      # LAPI for bouncers
      - 127.0.0.1:8080:8080
      # AppSec (WAF) - internal only
      - 127.0.0.1:7422:7422
      # Prometheus metrics
      - 127.0.0.1:6060:6060
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      # CrowdSec configuration
      - ./docker/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      # CrowdSec data persistence
      - ./docker/crowdsec/db:/var/lib/crowdsec/data
      - ./docker/crowdsec/config:/etc/crowdsec
      # Traefik logs for analysis
      - ./docker/traefik/logs:/var/log/traefik:ro
      # System logs for analysis
      - /var/log/syslog:/var/log/syslog:ro
      - /var/log/auth.log:/var/log/auth.log:ro
  crowdsec-web-ui:
    cap_drop:
      - ALL
    command: ["bun", "index.js"]
    container_name: crowdsec-web-ui
    entrypoint: []
    environment:
      - CROWDSEC_URL=http://crowdsec:8080
      - CROWDSEC_USER=crowdsec-web-ui
      - CROWDSEC_PASSWORD=${CROWDSEC_WEB_UI_PASSWORD:?CrowdSec Web UI password required}
      - CROWDSEC_REFRESH_INTERVAL=5s
      - CROWDSEC_IDLE_REFRESH_INTERVAL=5m
      - CROWDSEC_IDLE_THRESHOLD=2m
      - CROWDSEC_FULL_REFRESH_INTERVAL=5m
    image: ghcr.io/theduffman85/crowdsec-web-ui
    labels:
      traefik.enable: true
      traefik.http.routers.crowdsec-web-ui.middlewares: internal@file
      traefik.http.routers.crowdsec-web-ui.rule: Host(`crowdsec.mothership.${DOMAIN}`)
      traefik.http.routers.crowdsec-web-ui.service: crowdsec-web-ui
      traefik.http.services.crowdsec-web-ui.loadbalancer.server.port: 3000
    networks:
      - internal
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: 1000:1000
    volumes:
      - ./docker/crowdsec-web-ui/config:/app/config
      - ./docker/crowdsec-web-ui/data:/app/data

  # ===========================================================================
  # Docker Socket Proxy - Read-only Docker Socket
  # ===========================================================================
  docker-socket-proxy:
    container_name: docker-socket-proxy
    environment:
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
      POST: 0
      SERVICES: 1
      TASKS: 1
      VERSION: 1
      VOLUMES: 1
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 10s
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:2375/_ping || exit 1" ]
      timeout: 10s
    image: ghcr.io/tecnativa/docker-socket-proxy
    labels:
      traefik.enable: false
    ports:
      - ${INTERNAL_IP}:2375:2375
    privileged: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ===========================================================================
  # Gatus - Status Monitoring Dashboard
  # ===========================================================================
  gatus:
    cap_add:
      - NET_RAW
    cap_drop:
      - ALL
    container_name: gatus
    dns:
      - 100.100.1.1
      - 100.100.1.2
      - 100.100.1.3
    image: twinproduction/gatus
    labels:
      traefik.enable: true
      traefik.http.routers.gatus.middlewares: external-bypass@file
      traefik.http.routers.gatus.rule: Host(`status.${DOMAIN}`)
      traefik.http.services.gatus.loadbalancer.server.port: 8080
    networks:
      - external
      - internal
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./docker/gatus/config:/config:ro
      - ./docker/gatus/data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ===========================================================================
  # Gerbil - WireGuard Gateway
  # ===========================================================================
  gerbil:
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    command:
      - --reachableAt=http://gerbil:3004
      - --generateAndSaveKeyTo=/var/config/key
      - --remoteConfig=http://pangolin:3001/api/v1/
    container_name: gerbil
    depends_on:
      pangolin:
        condition: service_healthy
    image: fosrl/gerbil
    networks:
      - external
    ports:
      - 21820:21820/udp
      - 51820:51820/udp
    restart: unless-stopped
    volumes:
      - ./docker/gerbil:/var/config

  # ===========================================================================
  # GoAccess - Real-time Log Analytics Dashboard
  # ===========================================================================
  goaccess:
    container_name: goaccess
    environment:
      HTML_REFRESH: 5
      KEEP_LAST: 30
      LOG_TYPE: TRAEFIK
      PROCESSING_THREADS: 1
      TZ: ${TZ:-UTC}
    healthcheck:
      interval: 30s
      retries: 3
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:7880/ || exit 1" ]
      timeout: 10s
    image: xavierh/goaccess-for-nginxproxymanager
    labels:
      traefik.enable: true
      traefik.http.routers.goaccess.middlewares: external@file
      traefik.http.routers.goaccess.rule: Host(`goaccess.${DOMAIN}`)
      traefik.http.routers.goaccess.service: goaccess
      traefik.http.services.goaccess.loadbalancer.server.port: 7880
    networks:
      - external
      - internal
    restart: unless-stopped
    volumes:
      - ./docker/traefik/logs:/opt/log:ro

  # ===========================================================================
  # Pangolin - Service Tunneling Management UI
  # ===========================================================================
  pangolin:
    container_name: pangolin
    healthcheck:
      interval: 10s
      retries: 15
      test: [ "CMD", "curl", "-f", "http://localhost:3001/api/v1/" ]
      timeout: 10s
    image: fosrl/pangolin
    networks:
      - external
    restart: unless-stopped
    volumes:
      - ./docker/pangolin:/app/config

  # ===========================================================================
  # Pangolin Router - Host Routes & Container NAT Sidecar
  # ===========================================================================
  pangolin-router:
    container_name: pangolin-router
    depends_on:
      gerbil:
        condition: service_started
    entrypoint:
      - /bin/sh
      - -c
      - |
        apk add -q --no-cache iproute2; G=$$GERBIL_CONTAINER_NAME; S=$$DOCKER_SUBNET
        while sleep 30; do
          I=$$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $$G 2>/dev/null | awk '{print $$1}')
          [ -z "$$I" ] && continue
          for C in $$(docker exec $$G ip r show dev wg0 2>/dev/null | awk '/^100\./{print $$1}'); do
            ip r replace $$C via $$I
            R="-s $$S -d $$C -j MASQUERADE"; D="docker exec $$G iptables -t nat"
            $$D -C POSTROUTING $$R 2>/dev/null || $$D -A POSTROUTING $$R
          done
        done
    environment:
      DOCKER_SUBNET: 172.18.0.0/16
      GERBIL_CONTAINER_NAME: gerbil
    image: docker:29.1.3-cli-alpine3.23
    network_mode: host
    privileged: true
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # ===========================================================================
  # Tailscale - Mesh VPN
  # ===========================================================================
  tailscale:
    cap_add:
      - NET_ADMIN
      - NET_RAW
    cap_drop:
      - ALL
    container_name: tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      TS_AUTHKEY: ${TAILSCALE_AUTH_KEY:?tailscale auth key not defined}
      TS_EXTRA_ARGS: --accept-routes=true --advertise-exit-node=true
      TS_SOCKET: /var/run/tailscale/tailscaled.sock
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: false
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 60s
      test: [ "CMD-SHELL", "tailscale status --json | grep -q 'BackendState.*Running' || exit 1" ]
      timeout: 10s
    hostname: mothership
    image: tailscale/tailscale
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./docker/tailscale/data:/var/lib/tailscale:rw
      - ./docker/tailscale:/var/run/tailscale

  # ===========================================================================
  # Traefik - Reverse Proxy
  # ===========================================================================
  traefik:
    cap_add:
      - NET_BIND_SERVICE
    cap_drop:
      - ALL
    container_name: traefik
    depends_on:
      crowdsec:
        condition: service_healthy
      gerbil:
        condition: service_started
      tailscale:
        condition: service_healthy
    dns:
      - 100.100.1.1
      - 100.100.1.2
      - 100.100.1.3
    environment:
      # Cloudflare DNS Challenge for Let's Encrypt
      # Let's Encrypt email
      ACME_EMAIL: ${ACME_EMAIL:?ACME email required for Let's Encrypt}
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN:?Cloudflare API token required}
      # CrowdSec bouncer key (generate after first start)
      CROWDSEC_BOUNCER_KEY: ${CROWDSEC_BOUNCER_KEY:-}
      DOMAIN: ${DOMAIN:?Domain required}
      EXTERNAL_IP: ${EXTERNAL_IP:?external IP required}
      # Timezone
      TZ: ${TZ:-UTC}
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:80/ping || exit 1" ]
      timeout: 10s
    hostname: traefik
    image: traefik
    networks:
      - external
      - internal
    ports:
      - 80:80
      - 443:443
      - ${INTERNAL_IP}:8080:8080
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      # Docker socket (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik configuration
      - ./docker/traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro
      - ./docker/traefik/dynamic:/etc/traefik/dynamic:ro
      # Pangolin dynamic configuration
      - ./docker/pangolin/traefik/dynamic:/etc/traefik/pangolin-dynamic:ro
      # Certificates storage
      - ./docker/traefik/certs:/etc/traefik/certs
      # Pangolin certificates storage
      - ./docker/pangolin/letsencrypt:/letsencrypt
      # Logs (shared with CrowdSec and GoAccess)
      - ./docker/traefik/logs:/var/log/traefik
      # Pangolin logs
      - ./docker/pangolin/traefik/logs:/var/log/traefik-pangolin

  # ===========================================================================
  # Whoami - Test service
  # ===========================================================================
  whoami:
    cap_drop:
      - ALL
    container_name: whoami
    hostname: whoami
    image: traefik/whoami
    labels:
      traefik.enable: true
      traefik.http.routers.whoami.middlewares: external-basic@file
      traefik.http.routers.whoami.rule: Host(`whoami.${DOMAIN}`)
      traefik.http.services.whoami.loadbalancer.server.port: 80
    networks:
      - external
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    user: 65534:65534
